# KxDS

KxDS is an Envoy discovery service implementation for Kubernetes.
KxDS runs as a sidecar next to Envoy and configures the proxy to expose Kubernetes services.

### Features

* **Service Discovery** KxDS watches Kubernetes for ClusterIP services with a `http` named port
* **Envoy Clusters (CDS)** are generated for each Kubernetes service in the form `<service-name>-<namespace>-<http-port>`
* **Envoy Routes (RDS)** are generated for each cluster and mapped to the `<name>.<namespace>` domain
* **Envoy Weighted Clusters** are generated based on Kubernetes service annotations
* **Envoy Listeners (LDS)** KxDS configures Envoy to listen on port `8080` and sets up retry policies for each route

### Install

```sh
kubectl apply -k github.com/stefanprodan/kxds//kustomize/gateway
```

### Annotations

Kubernetes service:
```yaml
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: demo
  annotations:
    envoy.gateway.kubernetes.io/expose: "true"
    envoy.gateway.kubernetes.io/timeout: "25s"
    envoy.gateway.kubernetes.io/retries: "5"
    envoy.gateway.kubernetes.io/domain: "app.internal"
spec:
  ports:
    - name: http
      port: 9898
      protocol: TCP
```

Envoy virtual host (generated by KxDS):
```yaml
name: frontend-demo-9898
domains:
- "podinfo.local"
request_headers_to_add:
- header:
    key: "l5d-dst-override"
    value: "frontend.demo.svc.cluster.local:9898"
request_headers_to_remove:
- "l5d-remote-ip"
- "l5d-server-id"
routes:
- match:
    prefix: "/"
  route:
    cluster: frontend-demo-9898
    host_rewrite: "frontend.demo"
    timeout: 25s
    retry_policy:
      retry_on: "gateway-error,connect-failure,refused-stream"
      num_retries: 5
      per_try_timeout: 5s
```

Weighted destinations:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: podinfo
  namespace: demo
  annotations:
    envoy.gateway.kubernetes.io/expose: "true"
    envoy.gateway.kubernetes.io/domain: "podinfo.default"
    envoy.gateway.kubernetes.io/primary: "podinfo-primary-demo-9898"
    envoy.gateway.kubernetes.io/canary: "podinfo-canary-demo-9898"
    envoy.gateway.kubernetes.io/canary-weight: "50"
```

The primary and canary name format is `<service-name>-<namespace>-<port>`.
Note that both Kubernetes services must exist or Envoy will reject the configuration.
